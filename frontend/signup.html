<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Sign up - Alfred AI</title>
  <link rel="stylesheet" href="./src/styles/style.css">
  </head>
  <body class="auth-page">
  <div class="auth-container">
    <h2 style="display:none">Create account</h2>
    <div id="qaChat"></div>
    <div class="actions-row" style="display:flex;gap:8px;align-items:center">
      <input id="qaInput" placeholder="Type your answer here" style="flex:1;padding:10px;border-radius:8px;border:1px solid var(--border)" />
      <button class="btn-quiz" id="qaNext">Next</button>
    </div>
  <!-- navigation is command-based: type .signup or .login to switch flows -->
    <div id="signupMsg" style="margin-top:12px;color:var(--muted)"></div>
  </div>

  <script type="module" src="./src/pages/signup.js"></script>

  const qaChat = document.getElementById('qaChat');
  const qaInput = document.getElementById('qaInput');
  const qaNext = document.getElementById('qaNext');
  const signupMsg = document.getElementById('signupMsg');

  const steps = [
    { id: 'welcome', prompt: 'Welcome. Type .signup to create an account, .login to go back, or press Next to begin.' },
    { id: 'email', prompt: "What's your email?", key: 'email', required: true },
    { id: 'password', prompt: "Choose a password.", key: 'password', required: true, type: 'password' },
    { id: 'name', prompt: "What's your name?", key: 'name', required: true },
    { id: 'school', prompt: "Class / School (optional)", key: 'school', required: false }
  ];
  const answers = {};
  let idx = 0;

  // single prompt element (update text instead of stacking)
  const promptWrapper = document.createElement('div');
  promptWrapper.className = 'qa-prompt-wrapper'; promptWrapper.style.marginBottom = '8px';
  const promptInner = document.createElement('div'); promptInner.className = 'qa-prompt';
  promptWrapper.appendChild(promptInner);
  qaChat.appendChild(promptWrapper);

  function renderUser(text) {
    const d = document.createElement('div'); d.className = 'qa-user-wrapper'; d.style.marginBottom='8px'; d.innerHTML = `<div class="qa-user">${text}</div>`; qaChat.appendChild(d); qaChat.scrollTop = qaChat.scrollHeight;
  }

  function showStep() {
    const s = steps[idx];
    qaInput.type = s.type === 'password' ? 'password' : 'text';
    qaInput.value = '';
    if (s.id === 'password' && answers.email) {
      promptInner.textContent = "All that's left is your password.";
  qaInput.placeholder = "Choose a password";
    } else {
  promptInner.textContent = s.prompt;
  qaInput.placeholder = s.id === 'welcome' ? 'Type a command (.signup/.login) or press Next' : s.prompt;
    }
    qaChat.scrollTop = qaChat.scrollHeight;
    qaInput.focus();
  }

  async function finishSignup() {
    signupMsg.textContent = 'Creating account...';
    try {
      const payload = { email: answers.email, password: answers.password, name: answers.name, school: answers.school || '' };
      const r = await fetch(`${API_ROOT.replace(/\/$/, '')}/api/auth/signup`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      const j = await r.json();
      if (!r.ok) throw new Error(j && j.error ? j.error : 'Signup failed');
      localStorage.setItem(AUTH_TOKEN_KEY, j.token);
      localStorage.setItem('sa_seen_onboarding', '1');
      signupMsg.textContent = 'Account created — redirecting to preferences...';
      setTimeout(()=> location.href = '/profile.html', 700);
    } catch (e) { signupMsg.textContent = 'Signup failed: ' + String(e); }
  }

  qaNext.addEventListener('click', ()=>{
    const s = steps[idx];
    const val = qaInput.value.trim();
    if (s.required && !val) { signupMsg.textContent = 'This field is required.'; qaInput.focus(); return; }
    signupMsg.textContent = '';
  if (s.key) { answers[s.key] = val; renderUser(val && (s.type==='password' ? '••••••' : val)); }
  // dot-command handling
  if (val && val.startsWith('.')) {
    const cmd = val.slice(1).toLowerCase();
    if (cmd === 'login' || cmd === 'back') { location.href = '/login.html'; return; }
    if (cmd === 'home') { location.href = '/'; return; }
  }
  if (idx < steps.length - 1) { idx++; showStep(); } else { renderUser('Welcome — account created.'); finishSignup(); }
  });

  showStep();
  qaInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') qaNext.click(); });
  </script>
</body>
</html>
